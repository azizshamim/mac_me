#!/usr/bin/env bash
#
#  This file is used to run CI, and will
#  be invocated by the remote system.
DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
source $DIR/helpers

setup-test-ldap-server() {
    log "Setting up test LDAP server..."
    slapd-setup-test-server
}

destroy-test-ldap-server() {
    local _ldap_server_pid=
    _ldap_server_pid="$(lookup-pid slapd)"

    log "Stopping test LDAP server"
    slapd-server-stop $_ldap_server_pid
}

run-credo-analysis() {
    log "Running code analysis..."
    mix credo --strict
}

run-dogma-linter() {
    log "Running code linter..."
    mix dogma
}

run-tests() {
    log "Running code ..."
    mix test
}

init-cibuild() {
    setup-test-ldap-server
    # run-credo-analysis
    # run-dogma-linter
    run-tests
    destroy-test-ldap-server
}

init-cibuild
